{% extends "base/fetc_base.html" %}

{% load proposal_form_components %}
{% load messages %}
{% load static %}
{% load i18n %}

{% block header_title %}
    {% trans "Algemene informatie over de aanvraag" %} - {{ block.super }}
{% endblock %}

{% block html_head %}
    <script>
        $(function () {
            check_field_required('relation', 'needs_supervisor', 'supervisor', 'proposals');
            check_field_required('relation', 'check_in_course', 'student_program', 'proposals');
            check_field_required('relation', 'check_in_course', 'student_context', 'proposals');
            check_field_required('relation', 'check_in_course', 'student_justification', 'proposals');
            check_field_required('student_context', 'needs_details', 'student_context_details', 'proposals', 'studentcontext');
            depends_on_value('other_applicants', 'True', 'applicants');
            depends_on_value('other_stakeholders', 'True', 'stakeholders');
            check_field_required('funding', 'needs_details', 'funding_details', 'proposals');
            check_field_required('funding', 'needs_name', 'funding_name', 'proposals');

            // AJAX applicants
            $('select#id_applicants').select2({
                ajax: {
                    url: '{% url 'main:user_search' %}',
                    dataType: 'json',
                    data: function (params) {
                        return {
                            q: params.term || '*',
                            page: params.page || 1
                        }
                    },
                    delay: 1500,
                    error: function (err) {
                        console.log(err)
                    },
                    cache: true
                }
            });

            // AJAX supervisors
            $('select#id_supervisor').select2({
                ajax: {
                    url: '{% url 'main:user_search' %}',
                    dataType: 'json',
                    data: function (params) {
                        return {
                            q: params.term || '*',
                            page: params.page || 1
                        }
                    },
                    delay: 1500,
                    error: function (err) {
                        console.log(err)
                    },
                    cache: true
                }
            });

            // Add a running word count to the summary
            var summary = $("#id_summary");
            if (summary.length) {
                summary.after("<span id='wordcount' />");
                summary[0].addEventListener("input", function () {
                    var wordCount = 0;
                    if (this.value.trim()) {
                        wordCount = this.value.match(/\S+/g).length;
                    }
                    $("#wordcount").text(" {% trans 'Aantal woorden:' %} " + wordCount);
                }, false);
            }
        });

        /* Find date start input */
        let date_start_input = $("#id_date_start")

        /* Insert warning element */
        date_start_input.after(`
            <p id="date_start_warning" class="mb-2 mt-2">
            {% trans "Als de beoogde startdatum binnen twee weken van het indienen van de aanvraag ligt, kan de FETC geen officiÃ«le goedkeuring meer geven."%}
            </p>
        `)

        /* Re-select warning paragraph */
        const date_start_warning = $("#date_start_warning")

        /* Define checker function */
        function checkDateStart() {
            let date_value = date_start_input.val();
            if (date_value=="") {
                return true
            }
            let parsed_date = new Date(date_value);
            let today = new Date();
            let date_difference = parsed_date - today;
            const two_weeks_ms = 1000*60*60*24*14;
            return date_difference>two_weeks_ms;
        }

        /* Define warning update function */
        function updateWarning() {
            date_start_warning.toggleClass("text-danger", checkDateStart()==false);
        }

        /* Listen for changing of start date */
        date_start_input.on('change', () => {
            updateWarning();
        });

        /* Give the update function a warmup run */
        updateWarning();
    </script>
    <style>
        #date_start_warning {
            line-height: 1.5;
        }
    </style>
{% endblock %}

{% block pre-messages-content %}
    {% proposal_hero object create %}
    {% display_messages messages %}
{% endblock %}

{% block content %}
    <div class="uu-container flex-lg-nowrap gap-3 gap-lg-5">
        {% stepper object create is_pre_assessment %}
        <div class="flex-fill">
            {% if is_practice %}
                <div class="alert alert-info">
                    {% trans "Je bewerkt op het moment een oefenaanvraag. Deze kan niet ter beoordeling door de FETC-GW worden ingediend." %}
                </div>
            {% endif %}
            <h2>{% trans "Algemene informatie over de aanvraag" %}</h2>
            {% if not create and is_supervisor %}
                {% blocktrans trimmed %}
                    Je past nu een aanvraag aan van een student/PhD kandidaat onder jouw supervisie. Let er op dat je
                    het formulier invult alsof jij die student/PhD kandidaat bent.
                {% endblocktrans %}
                <br/>
                <br/>
            {% endif %}
            {% block form %}
                <form action="" class="uu-form" method="post" enctype="multipart/form-data">{% csrf_token %}
                    {{ form }}
                    {% form_buttons object False %}
                </form>
            {% endblock %}
        </div>
    </div>
{% endblock %}
