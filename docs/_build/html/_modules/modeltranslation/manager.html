

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>modeltranslation.manager &mdash; ETCL 1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ETCL
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">General</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../general/index.html">General</a></li>
</ul>
<p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation/local/index.html">Local development installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/server/index.html">Server Deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">Maintenance &amp; Administration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../maintenance/index.html">Maintenance</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../developing/index.html">General</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developing/tests.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developing/i18n.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developing/documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developing/toolset.html">Toolset</a></li>
</ul>
<p class="caption"><span class="caption-text">Code Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">etcl</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ETCL</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>modeltranslation.manager</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for modeltranslation.manager</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The idea of MultilingualManager is taken from</span>
<span class="sd">django-linguo by Zach Mathew</span>

<span class="sd">https://github.com/zmathew/django-linguo</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">import</span> <span class="nn">django</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django.contrib.admin.utils</span> <span class="k">import</span> <span class="n">get_model_from_relation</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django.contrib.admin.util</span> <span class="k">import</span> <span class="n">get_model_from_relation</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">FieldDoesNotExist</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django.db.models.fields.related</span> <span class="k">import</span> <span class="n">RelatedObject</span>
    <span class="kn">from</span> <span class="nn">django.db.models.fields.related</span> <span class="k">import</span> <span class="n">RelatedField</span>
    <span class="n">NEW_META_API</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">NEW_META_API</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django.db.models.query</span> <span class="k">import</span> <span class="n">ValuesQuerySet</span>
    <span class="kn">from</span> <span class="nn">django.db.models.sql.where</span> <span class="k">import</span> <span class="n">Constraint</span>
    <span class="n">NEW_RELATED_API</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django.db.models.query</span> <span class="k">import</span> <span class="n">ValuesIterable</span>
    <span class="n">NEW_RELATED_API</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Django 1.9</span>

<span class="kn">from</span> <span class="nn">django.utils.six</span> <span class="k">import</span> <span class="n">moves</span>
<span class="kn">from</span> <span class="nn">django.utils.tree</span> <span class="k">import</span> <span class="n">Node</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django.db.models.lookups</span> <span class="k">import</span> <span class="n">Lookup</span>
    <span class="kn">from</span> <span class="nn">django.db.models.sql.datastructures</span> <span class="k">import</span> <span class="n">Col</span>
    <span class="n">NEW_LOOKUPS</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Django 1.7, 1.8</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">NEW_LOOKUPS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">from</span> <span class="nn">modeltranslation</span> <span class="k">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">modeltranslation.fields</span> <span class="k">import</span> <span class="n">TranslationField</span>
<span class="kn">from</span> <span class="nn">modeltranslation.utils</span> <span class="k">import</span> <span class="p">(</span><span class="n">build_localized_fieldname</span><span class="p">,</span> <span class="n">get_language</span><span class="p">,</span>
                                    <span class="n">auto_populate</span><span class="p">,</span> <span class="n">resolution_order</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_translatable_fields_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">modeltranslation.translator</span> <span class="k">import</span> <span class="n">NotRegistered</span><span class="p">,</span> <span class="n">translator</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">translator</span><span class="o">.</span><span class="n">get_options_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">NotRegistered</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">rewrite_lookup_key</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lookup_key</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pieces</span> <span class="o">=</span> <span class="n">lookup_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">original_key</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">translatable_fields</span> <span class="o">=</span> <span class="n">get_translatable_fields_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">translatable_fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If we are doing a lookup on a translatable field,</span>
            <span class="c1"># we want to rewrite it to the actual field name</span>
            <span class="c1"># For example, we want to rewrite &quot;name__startswith&quot; to &quot;name_fr__startswith&quot;</span>
            <span class="k">if</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">translatable_fields</span><span class="p">:</span>
                <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_localized_fieldname</span><span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">get_language</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Check if we are doing a lookup to a related trans model</span>
            <span class="n">fields_to_trans_models</span> <span class="o">=</span> <span class="n">get_fields_to_translatable_models</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="c1"># Check ``original key``, as pieces[0] may have been already rewritten.</span>
            <span class="k">if</span> <span class="n">original_key</span> <span class="ow">in</span> <span class="n">fields_to_trans_models</span><span class="p">:</span>
                <span class="n">transmodel</span> <span class="o">=</span> <span class="n">fields_to_trans_models</span><span class="p">[</span><span class="n">original_key</span><span class="p">]</span>
                <span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rewrite_lookup_key</span><span class="p">(</span><span class="n">transmodel</span><span class="p">,</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="s1">&#39;__&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lookup_key</span>


<span class="k">def</span> <span class="nf">append_fallback</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If translated field is encountered, add also all its fallback fields.</span>
<span class="sd">    Returns tuple: (set_of_new_fields_to_use, set_of_translated_field_names)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="kn">from</span> <span class="nn">modeltranslation.translator</span> <span class="k">import</span> <span class="n">translator</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">get_options_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">langs</span> <span class="o">=</span> <span class="n">resolution_order</span><span class="p">(</span><span class="n">get_language</span><span class="p">(),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fallback_languages</span><span class="p">)</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">build_localized_fieldname</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span> <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">)</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">trans</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fields</span><span class="p">,</span> <span class="n">trans</span>


<span class="k">def</span> <span class="nf">append_translated</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
    <span class="s2">&quot;If translated field is encountered, add also all its translation fields.&quot;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">modeltranslation.translator</span> <span class="k">import</span> <span class="n">translator</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">get_options_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">translated</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">translated</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fields</span>


<span class="k">def</span> <span class="nf">append_lookup_key</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lookup_key</span><span class="p">):</span>
    <span class="s2">&quot;Transform spanned__lookup__key into all possible translation versions, on all levels&quot;</span>
    <span class="n">pieces</span> <span class="o">=</span> <span class="n">lookup_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="n">append_translated</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Check if we are doing a lookup to a related trans model</span>
        <span class="n">fields_to_trans_models</span> <span class="o">=</span> <span class="n">get_fields_to_translatable_models</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">fields_to_trans_models</span><span class="p">:</span>
            <span class="n">transmodel</span> <span class="o">=</span> <span class="n">fields_to_trans_models</span><span class="p">[</span><span class="n">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">rest</span> <span class="o">=</span> <span class="n">append_lookup_key</span><span class="p">(</span><span class="n">transmodel</span><span class="p">,</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span> <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">rest</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">__</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fields</span>


<span class="k">def</span> <span class="nf">append_lookup_keys</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
    <span class="n">new_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_field</span> <span class="o">=</span> <span class="n">append_lookup_key</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">new_field</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span><span class="p">,)</span>
        <span class="n">new_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_field</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">moves</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">,</span> <span class="n">new_fields</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">rewrite_order_lookup_key</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lookup_key</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lookup_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">rewrite_lookup_key</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lookup_key</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rewrite_lookup_key</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">lookup_key</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lookup_key</span>

<span class="n">_F2TM_CACHE</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">get_fields_to_translatable_models</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">_F2TM_CACHE</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_F2TM_CACHE</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">NEW_META_API</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_relation</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">related_model</span><span class="p">:</span>
                <span class="c1"># The new get_field() will find GenericForeignKey relations.</span>
                <span class="c1"># In that case the &#39;related_model&#39; attribute is set to None</span>
                <span class="c1"># so it is necessary to check for this value before trying to</span>
                <span class="c1"># get translatable fields.</span>
                <span class="n">related_model</span> <span class="o">=</span> <span class="n">get_model_from_relation</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">get_translatable_fields_for_model</span><span class="p">(</span><span class="n">related_model</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">related_model</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_all_field_names</span><span class="p">():</span>
            <span class="n">field_object</span><span class="p">,</span> <span class="n">modelclass</span><span class="p">,</span> <span class="n">direct</span><span class="p">,</span> <span class="n">m2m</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field_by_name</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="c1"># Direct relationship</span>
            <span class="k">if</span> <span class="n">direct</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_object</span><span class="p">,</span> <span class="n">RelatedField</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">get_translatable_fields_for_model</span><span class="p">(</span><span class="n">field_object</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">parent_model</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field_object</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">parent_model</span><span class="p">))</span>
            <span class="c1"># Reverse relationship</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_object</span><span class="p">,</span> <span class="n">RelatedObject</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">get_translatable_fields_for_model</span><span class="p">(</span><span class="n">field_object</span><span class="o">.</span><span class="n">model</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field_object</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>
    <span class="n">_F2TM_CACHE</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_F2TM_CACHE</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>

<span class="n">_C2F_CACHE</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">get_field_by_colum_name</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
    <span class="c1"># First, try field with the column name</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">column</span> <span class="o">==</span> <span class="n">col</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">field</span>
    <span class="k">except</span> <span class="n">FieldDoesNotExist</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">_C2F_CACHE</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">model</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">field</span>
    <span class="c1"># D&#39;oh, need to search through all of them.</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">column</span> <span class="o">==</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">_C2F_CACHE</span><span class="p">[(</span><span class="n">model</span><span class="p">,</span> <span class="n">col</span><span class="p">)]</span> <span class="o">=</span> <span class="n">field</span>
            <span class="k">return</span> <span class="n">field</span>
    <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;No field found for column </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">col</span>


<span class="k">class</span> <span class="nc">MultilingualQuerySet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">QuerySet</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_post_init</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">ordering</span><span class="p">:</span>
                <span class="c1"># If we have default ordering specified on the model, set it now so that</span>
                <span class="c1"># it can be rewritten. Otherwise sql.compiler will grab it directly from _meta</span>
                <span class="n">ordering</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">ordering</span><span class="p">:</span>
                    <span class="n">ordering</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rewrite_order_lookup_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">add_ordering</span><span class="p">(</span><span class="o">*</span><span class="n">ordering</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">multilingual_queryset_factory</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">if</span> <span class="n">NEW_RELATED_API</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;_rewrite&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;_populate&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populate</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;translation_fields&#39;</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;translation_fields&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">translation_fields</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fields_to_del&#39;</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;fields_to_del&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_to_del</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;original_fields&#39;</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;original_fields&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_fields</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">klass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">MultilingualQuerySet</span><span class="p">):</span>
                <span class="k">class</span> <span class="nc">NewClass</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">MultilingualQuerySet</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="n">NewClass</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;Multilingual</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">klass</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">klass</span> <span class="o">=</span> <span class="n">NewClass</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;_rewrite&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;_populate&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populate</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">rewrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">_rewrite</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overrides the translation fields population mode for this query set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">_populate</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rewrite_applied_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rewrite fields in already applied filters/ordering.</span>
<span class="sd">        Useful when converting any QuerySet into MultilingualQuerySet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NEW_RELATED_API</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">having</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_order</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_select_related</span><span class="p">()</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">select_related</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="o">*</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># TO CONSIDER: whether this should rewrite only current language, or all languages?</span>
        <span class="c1"># fk -&gt; [fk, fk_en] (with en=active) VS fk -&gt; [fk, fk_en, fk_de, fk_fr ...] (for all langs)</span>

        <span class="c1"># new_args = append_lookup_keys(self.model, fields)</span>
        <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rewrite_lookup_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="o">*</span><span class="n">new_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">_rewrite_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Django &gt;= 1.7 column name rewriting&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">Col</span><span class="p">):</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">rewrite_lookup_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">new_name</span><span class="p">:</span>
                <span class="n">new_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="n">col</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
                    <span class="n">col</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">new_field</span>
                <span class="n">col</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">new_field</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_col</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;lhs&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_col</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rewrite_where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rewrite field names inside WHERE tree.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NEW_LOOKUPS</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Constraint</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">get_field_by_colum_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">rewrite_lookup_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">new_name</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">column</span>
        <span class="k">elif</span> <span class="n">NEW_LOOKUPS</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Lookup</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_col</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_where</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rewrite_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="p">[</span><span class="n">rewrite_order_lookup_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_rewrite_select_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select_related</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">new</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select_related</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">new</span><span class="p">[</span><span class="n">rewrite_order_lookup_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select_related</span> <span class="o">=</span> <span class="n">new</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">_rewrite_q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rewrite field names inside Q call.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rewrite_lookup_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="n">q</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_q</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">children</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">q</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">_rewrite_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rewrite field names inside F call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">F</span><span class="p">):</span>
            <span class="n">q</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">rewrite_lookup_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">q</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="n">q</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_f</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">children</span><span class="p">))</span>
        <span class="c1"># Django &gt;= 1.8</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s1">&#39;lhs&#39;</span><span class="p">):</span>
            <span class="n">q</span><span class="o">.</span><span class="n">lhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_f</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s1">&#39;rhs&#39;</span><span class="p">):</span>
            <span class="n">q</span><span class="o">.</span><span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_f</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q</span>

    <span class="k">def</span> <span class="nf">_filter_or_exclude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">negate</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_filter_or_exclude</span><span class="p">(</span><span class="n">negate</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_q</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="n">rewrite_lookup_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_f</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_filter_or_exclude</span><span class="p">(</span><span class="n">negate</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_original_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_fields</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="s1">&#39;concrete_fields&#39;</span><span class="p">)</span>
                  <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">attname</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">source</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">TranslationField</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">field_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change translatable field names in an ``order_by`` argument</span>
<span class="sd">        to translation fields for the current language.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">*</span><span class="n">field_names</span><span class="p">)</span>
        <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rewrite_order_lookup_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">*</span><span class="n">new_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="n">rewrite_lookup_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_f</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">update</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_populate_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Populate can be set using a global setting or a manager method.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">AUTO_POPULATE</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populate</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allows to override population mode with a ``populate`` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">auto_populate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_populate_mode</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allows to override population mode with a ``populate`` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">auto_populate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_populate_mode</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">defer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">append_lookup_keys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="o">*</span><span class="n">fields</span><span class="p">)</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">append_lookup_keys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="o">*</span><span class="n">fields</span><span class="p">)</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">raw_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">*</span><span class="n">fields</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">original</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prepare&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_values</span><span class="p">(</span><span class="o">*</span><span class="n">original</span><span class="p">)</span>
        <span class="n">new_fields</span><span class="p">,</span> <span class="n">translation_fields</span> <span class="o">=</span> <span class="n">append_fallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_values</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">new_fields</span><span class="p">))</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">original_fields</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">translation_fields</span> <span class="o">=</span> <span class="n">translation_fields</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">fields_to_del</span> <span class="o">=</span> <span class="n">new_fields</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clone</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">*</span><span class="n">fields</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
            <span class="c1"># Emulate original queryset behaviour: get all fields that are not translation fields</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_original_fields</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">NEW_RELATED_API</span><span class="p">:</span>
            <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">(</span><span class="o">*</span><span class="n">fields</span><span class="p">,</span> <span class="n">prepare</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">_iterable_class</span> <span class="o">=</span> <span class="n">FallbackValuesIterable</span>
            <span class="k">return</span> <span class="n">clone</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">klass</span><span class="o">=</span><span class="n">FallbackValuesQuerySet</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_fields</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">values_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="o">*</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unexpected keyword arguments to values_list: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">),))</span>
        <span class="k">if</span> <span class="n">flat</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;flat&#39; is not valid when values_list is &quot;</span>
                            <span class="s2">&quot;called with more than one field.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
            <span class="c1"># Emulate original queryset behaviour: get all fields that are not translation fields</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_original_fields</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">NEW_RELATED_API</span><span class="p">:</span>
            <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">(</span><span class="o">*</span><span class="n">fields</span><span class="p">,</span> <span class="n">prepare</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">_iterable_class</span> <span class="o">=</span> <span class="p">(</span><span class="n">FallbackFlatValuesListIterable</span> <span class="k">if</span> <span class="n">flat</span>
                                     <span class="k">else</span> <span class="n">FallbackValuesListIterable</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">clone</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">klass</span><span class="o">=</span><span class="n">FallbackValuesListQuerySet</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="n">flat</span><span class="p">,</span>
                               <span class="n">_fields</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span>

    <span class="c1"># This method was not present in django-linguo</span>
    <span class="k">def</span> <span class="nf">dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="n">rewrite_lookup_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="n">new_key</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">if</span> <span class="n">NEW_RELATED_API</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">FallbackValuesIterable</span><span class="p">(</span><span class="n">ValuesIterable</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">X</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="c1"># This stupid class is needed as object use __slots__ and has no __dict__.</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">FallbackValuesIterable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">():</span>
                <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">translation_fields</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">fields_to_del</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">yield</span> <span class="n">row</span>

    <span class="k">class</span> <span class="nc">FallbackValuesListIterable</span><span class="p">(</span><span class="n">FallbackValuesIterable</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">original_fields</span>
            <span class="n">fields</span> <span class="o">+=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">annotation_select</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">FallbackValuesListIterable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">():</span>
                <span class="k">yield</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">FallbackFlatValuesListIterable</span><span class="p">(</span><span class="n">FallbackValuesListIterable</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">FallbackFlatValuesListIterable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">else</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">FallbackValuesQuerySet</span><span class="p">(</span><span class="n">ValuesQuerySet</span><span class="p">,</span> <span class="n">MultilingualQuerySet</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_setup_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span>
            <span class="n">new_fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">translation_fields</span> <span class="o">=</span> <span class="n">append_fallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_fields</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_to_del</span> <span class="o">=</span> <span class="n">new_fields</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">FallbackValuesQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_setup_query</span><span class="p">()</span>

        <span class="k">class</span> <span class="nc">X</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="c1"># This stupid class is needed as object use __slots__ and has no __dict__.</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">FallbackValuesQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">iterator</span><span class="p">():</span>
                <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">translation_fields</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_to_del</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">yield</span> <span class="n">row</span>

        <span class="k">def</span> <span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">FallbackValuesQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">fields_to_del</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_to_del</span>
            <span class="n">c</span><span class="o">.</span><span class="n">translation_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translation_fields</span>
            <span class="k">if</span> <span class="n">setup</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;_setup_query&#39;</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">_setup_query</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">c</span>

    <span class="k">class</span> <span class="nc">FallbackValuesListQuerySet</span><span class="p">(</span><span class="n">FallbackValuesQuerySet</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_fields</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;aggregate_names&#39;</span><span class="p">):</span>
                <span class="c1"># Django &lt;1.8</span>
                <span class="n">fields</span> <span class="o">+=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_names</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;annotation_names&#39;</span><span class="p">):</span>
                <span class="c1"># Django &gt;=1.8</span>
                <span class="n">fields</span> <span class="o">+=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotation_names</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">FallbackValuesListQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">iterator</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">row</span><span class="p">[</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_setup_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">original_fields</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">FallbackValuesListQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_setup_query</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">clone</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">FallbackValuesListQuerySet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">original_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_fields</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="s2">&quot;flat&quot;</span><span class="p">):</span>
                <span class="c1"># Only assign flat if the clone didn&#39;t already get it from kwargs</span>
                <span class="n">clone</span><span class="o">.</span><span class="n">flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat</span>
            <span class="k">return</span> <span class="n">clone</span>


<span class="k">def</span> <span class="nf">multilingual_queryset_factory</span><span class="p">(</span><span class="n">old_cls</span><span class="p">,</span> <span class="n">instantiate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">old_cls</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">QuerySet</span><span class="p">:</span>
        <span class="n">NewClass</span> <span class="o">=</span> <span class="n">MultilingualQuerySet</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">class</span> <span class="nc">NewClass</span><span class="p">(</span><span class="n">old_cls</span><span class="p">,</span> <span class="n">MultilingualQuerySet</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="n">NewClass</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;Multilingual</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">old_cls</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="n">NewClass</span><span class="p">()</span> <span class="k">if</span> <span class="n">instantiate</span> <span class="k">else</span> <span class="n">NewClass</span>


<span class="k">class</span> <span class="nc">MultilingualQuerysetManager</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class gets hooked in MRO just before plain Manager, so that every call to</span>
<span class="sd">    get_queryset returns MultilingualQuerySet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualQuerysetManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patch_queryset</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_patch_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="p">):</span>
        <span class="n">qs</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">multilingual_queryset_factory</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instantiate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">qs</span><span class="o">.</span><span class="n">_post_init</span><span class="p">()</span>
        <span class="n">qs</span><span class="o">.</span><span class="n">_rewrite_applied_operations</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">qs</span>


<span class="k">class</span> <span class="nc">MultilingualManager</span><span class="p">(</span><span class="n">MultilingualQuerysetManager</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">django</span><span class="o">.</span><span class="n">VERSION</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">use_for_related_fields</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">rewrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">rewrite</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">raw_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">raw_values</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is repeated because some managers that don&#39;t use super() or alter queryset class</span>
<span class="sd">        may return queryset that is not subclass of MultilingualQuerySet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultilingualManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">MultilingualQuerySet</span><span class="p">):</span>
            <span class="c1"># Is already patched by MultilingualQuerysetManager - in most of the cases</span>
            <span class="c1"># when custom managers use super() properly in get_queryset.</span>
            <span class="k">return</span> <span class="n">qs</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patch_queryset</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Martijn van der Klis &amp; Ty Mees

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>