

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>modeltranslation.translator &mdash; ETCL 1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ETCL
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">General</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../general/index.html">General</a></li>
</ul>
<p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation/local/index.html">Local development installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/server/index.html">Server Deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">Maintenance &amp; Administration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../maintenance/index.html">Maintenance</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../developing/index.html">General</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developing/tests.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developing/i18n.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developing/documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developing/toolset.html">Toolset</a></li>
</ul>
<p class="caption"><span class="caption-text">Code Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">etcl</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ETCL</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>modeltranslation.translator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for modeltranslation.translator</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="k">import</span> <span class="n">VERSION</span>
<span class="kn">from</span> <span class="nn">django.utils.six</span> <span class="k">import</span> <span class="n">with_metaclass</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Manager</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">OneToOneField</span>
<span class="kn">from</span> <span class="nn">django.db.models.base</span> <span class="k">import</span> <span class="n">ModelBase</span>
<span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="k">import</span> <span class="n">post_init</span>

<span class="kn">from</span> <span class="nn">modeltranslation</span> <span class="k">import</span> <span class="n">settings</span> <span class="k">as</span> <span class="n">mt_settings</span>
<span class="kn">from</span> <span class="nn">modeltranslation.fields</span> <span class="k">import</span> <span class="p">(</span><span class="n">NONE</span><span class="p">,</span> <span class="n">create_translation_field</span><span class="p">,</span> <span class="n">TranslationFieldDescriptor</span><span class="p">,</span>
                                     <span class="n">TranslatedRelationIdDescriptor</span><span class="p">,</span>
                                     <span class="n">LanguageCacheSingleObjectDescriptor</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">modeltranslation.manager</span> <span class="k">import</span> <span class="p">(</span><span class="n">MultilingualManager</span><span class="p">,</span> <span class="n">MultilingualQuerysetManager</span><span class="p">,</span>
                                      <span class="n">rewrite_lookup_key</span><span class="p">,</span> <span class="n">append_translated</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">modeltranslation.utils</span> <span class="k">import</span> <span class="n">build_localized_fieldname</span><span class="p">,</span> <span class="n">parse_field</span>


<span class="n">NEW_RELATED_API</span> <span class="o">=</span> <span class="n">VERSION</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">NEW_DEFERRED_API</span> <span class="o">=</span> <span class="n">NEW_MANAGER_API</span> <span class="o">=</span> <span class="n">NEW_ABSTRACT_API</span> <span class="o">=</span> <span class="n">VERSION</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AlreadyRegistered</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">NotRegistered</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">DescendantRegistered</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">FieldsAggregationMetaClass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Metaclass to handle custom inheritance of fields between classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="p">()))</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">FieldsAggregationMetaClass</span><span class="p">):</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">FieldsAggregationMetaClass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TranslationOptions</span><span class="p">(</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">FieldsAggregationMetaClass</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translatable fields are declared by registering a model using</span>
<span class="sd">    ``TranslationOptions`` class with appropriate ``fields`` attribute.</span>
<span class="sd">    Model-specific fallback values and languages can also be given as class</span>
<span class="sd">    attributes.</span>

<span class="sd">    Options instances hold info about translatable fields for a model and its</span>
<span class="sd">    superclasses. The ``local_fields`` and ``fields`` attributes are mappings</span>
<span class="sd">    from fields to sets of their translation fields; ``local_fields`` contains</span>
<span class="sd">    only those fields that are handled in the model&#39;s database table (those</span>
<span class="sd">    inherited from abstract superclasses, unless there is a concrete superclass</span>
<span class="sd">    in between in the inheritance chain), while ``fields`` also includes fields</span>
<span class="sd">    inherited from concrete supermodels (giving all translated fields available</span>
<span class="sd">    on a model).</span>

<span class="sd">    ``related`` attribute inform whether this model is related part of some relation</span>
<span class="sd">    with translated model. This model may be not translated itself.</span>
<span class="sd">    ``related_fields`` contains names of reverse lookup fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_languages</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create fields dicts without any translation fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">related</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">related_fields</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform options validation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: at the moment only required_languages is validated.</span>
        <span class="c1"># Maybe check other options as well?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_languages</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_languages</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_languages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_languages</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_languages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_languages</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">extra</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,))</span>
                <span class="k">for</span> <span class="n">fieldnames</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_languages</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
                            <span class="s1">&#39;Fieldname in required_languages which is not in fields option.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_languages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">languages</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">()):</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mt_settings</span><span class="o">.</span><span class="n">AVAILABLE_LANGUAGES</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">correct</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">languages</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
                <span class="s1">&#39;Language in required_languages which is not in AVAILABLE_LANGUAGES.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update with options from a superclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">abstract</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">local_fields</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_translation_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">translation_field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new translation field to both fields dicts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">translation_field</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">translation_field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_field_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return name of all fields that can be used in filtering.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_fields</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">local</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">inherited</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">local</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> + </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">inherited</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add_translation_fields</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monkey patches the original model class to provide additional fields for</span>
<span class="sd">    every language.</span>

<span class="sd">    Adds newly created translation fields to the given translation options.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_empty_values</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s1">&#39;empty_values&#39;</span><span class="p">,</span> <span class="n">NONE</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">local_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">field_empty_value</span> <span class="o">=</span> <span class="n">parse_field</span><span class="p">(</span><span class="n">model_empty_values</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">NONE</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">mt_settings</span><span class="o">.</span><span class="n">AVAILABLE_LANGUAGES</span><span class="p">:</span>
            <span class="c1"># Create a dynamic translation field</span>
            <span class="n">translation_field</span> <span class="o">=</span> <span class="n">create_translation_field</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">empty_value</span><span class="o">=</span><span class="n">field_empty_value</span><span class="p">)</span>
            <span class="c1"># Construct the name for the localized field</span>
            <span class="n">localized_field_name</span> <span class="o">=</span> <span class="n">build_localized_fieldname</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
            <span class="c1"># Check if the model already has a field by that name</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">localized_field_name</span><span class="p">):</span>
                <span class="c1"># Check if are not dealing with abstract field inherited.</span>
                <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;_meta&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">localized_field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">cls_opts</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">_get_options_for_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">abstract</span> <span class="ow">or</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls_opts</span><span class="o">.</span><span class="n">local_fields</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error adding translation field. Model &#39;</span><span class="si">%s</span><span class="s2">&#39; already&quot;</span>
                                             <span class="s2">&quot; contains a field named &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span>
                                             <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">localized_field_name</span><span class="p">))</span>
            <span class="c1"># This approach implements the translation fields as full valid</span>
            <span class="c1"># django model fields and therefore adds them via add_to_class</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add_to_class</span><span class="p">(</span><span class="n">localized_field_name</span><span class="p">,</span> <span class="n">translation_field</span><span class="p">)</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">add_translation_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">translation_field</span><span class="p">)</span>

    <span class="c1"># Rebuild information about parents fields. If there are opts.local_fields, field cache would be</span>
    <span class="c1"># invalidated (by model._meta.add_field() function). Otherwise, we need to do it manually.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">local_fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">_fill_fields_cache</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># Django 1.8 removed _fill_fields_cache</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">_expire_cache</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">has_custom_queryset</span><span class="p">(</span><span class="n">manager</span><span class="p">):</span>
    <span class="s2">&quot;Check whether manager (or its parents) has declared some custom get_queryset method.&quot;</span>
    <span class="n">old_diff</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s1">&#39;get_query_set&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">Manager</span><span class="p">,</span> <span class="s1">&#39;get_query_set&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">new_diff</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s1">&#39;get_queryset&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">Manager</span><span class="p">,</span> <span class="s1">&#39;get_queryset&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">old_diff</span> <span class="ow">or</span> <span class="n">new_diff</span>


<span class="k">def</span> <span class="nf">add_manager</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monkey patches the original model to use MultilingualManager instead of</span>
<span class="sd">    default managers (not only ``objects``, but also every manager defined and inherited).</span>

<span class="sd">    Custom managers are merged with MultilingualManager.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">abstract</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">patch_manager_class</span><span class="p">(</span><span class="n">manager</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">MultilingualManager</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">Manager</span><span class="p">:</span>
            <span class="n">manager</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">MultilingualManager</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">class</span> <span class="nc">NewMultilingualManager</span><span class="p">(</span><span class="n">MultilingualManager</span><span class="p">,</span> <span class="n">manager</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                                         <span class="n">MultilingualQuerysetManager</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">VERSION</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
                    <span class="n">use_for_related_fields</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                        <span class="n">manager</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                        <span class="s2">&quot;use_for_related_fields&quot;</span><span class="p">,</span>
                        <span class="ow">not</span> <span class="n">has_custom_queryset</span><span class="p">(</span><span class="n">manager</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="n">_old_module</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="vm">__module__</span>
                <span class="n">_old_class</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

                <span class="k">def</span> <span class="nf">deconstruct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">(</span>
                        <span class="kc">False</span><span class="p">,</span>  <span class="c1"># as_manager</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_old_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_old_class</span><span class="p">),</span>  <span class="c1"># manager_class</span>
                        <span class="kc">None</span><span class="p">,</span>  <span class="c1"># qs_class</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_constructor_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># args</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_constructor_args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># kwargs</span>
                    <span class="p">)</span>

            <span class="n">manager</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">NewMultilingualManager</span>

    <span class="k">if</span> <span class="n">NEW_MANAGER_API</span><span class="p">:</span>
        <span class="c1"># Inspired by django.db.models.options.Options.managers (find all</span>
        <span class="c1"># managers by following the normal Python MRO rules), but keeps the</span>
        <span class="c1"># original managers instead of making copies.</span>
        <span class="n">managers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">bases</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">mro</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;_meta&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">local_managers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">managers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">managers</span> <span class="o">=</span> <span class="p">((</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                     <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_managers</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">abstract_managers</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">current_manager</span> <span class="ow">in</span> <span class="n">managers</span><span class="p">:</span>
        <span class="n">prev_class</span> <span class="o">=</span> <span class="n">current_manager</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">patch_manager_class</span><span class="p">(</span><span class="n">current_manager</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">prev_class</span><span class="p">:</span>
            <span class="c1"># Normally model._default_manager is a reference to one of model&#39;s managers</span>
            <span class="c1"># (and would be patched by the way).</span>
            <span class="c1"># However, in some rare situations (mostly proxy models)</span>
            <span class="c1"># model._default_manager is not the same instance as one of managers, but it</span>
            <span class="c1"># share the same class.</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">current_manager</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="n">patch_manager_class</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_base_manager</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERSION</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">base_manager_name</span> <span class="o">=</span> <span class="s1">&#39;objects&#39;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="s2">&quot;_expire_cache&quot;</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">_expire_cache</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">patch_constructor</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monkey patches the original model to rewrite fields names in __init__</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old_init</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="fm">__init__</span>

    <span class="k">def</span> <span class="nf">new_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mt_init</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">NEW_DEFERRED_API</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deferred</span><span class="p">:</span>
            <span class="n">populate_translation_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">new_key</span> <span class="o">=</span> <span class="n">rewrite_lookup_key</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="c1"># Old key is intentionally left in case old_init wants to play with it</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">new_key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">old_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="n">new_init</span>


<span class="k">def</span> <span class="nf">delete_mt_init</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s1">&#39;_mt_init&#39;</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">instance</span><span class="o">.</span><span class="n">_mt_init</span>


<span class="k">def</span> <span class="nf">patch_clean_fields</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Patch clean_fields method to handle different form types submission.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old_clean_fields</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">clean_fields</span>

    <span class="k">def</span> <span class="nf">new_clean_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_mt_form_pending_clear&#39;</span><span class="p">):</span>
            <span class="c1"># Some form translation fields has been marked as clearing value.</span>
            <span class="c1"># Check if corresponding translated field was also saved (not excluded):</span>
            <span class="c1"># - if yes, it seems like form for MT-unaware app. Ignore clearing (left value from</span>
            <span class="c1">#   translated field unchanged), as if field was omitted from form</span>
            <span class="c1"># - if no, then proceed as normally: clear the field</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mt_form_pending_clear</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
                <span class="n">orig_field_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">translated_field</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">orig_field_name</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">save_form_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_mt_form_pending_clear&#39;</span><span class="p">)</span>
        <span class="n">old_clean_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">clean_fields</span> <span class="o">=</span> <span class="n">new_clean_fields</span>


<span class="k">def</span> <span class="nf">patch_get_deferred_fields</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Django &gt;= 1.8: patch detecting deferred fields. Crucial for only/defer to work.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;get_deferred_fields&#39;</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">old_get_deferred_fields</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_deferred_fields</span>

    <span class="k">def</span> <span class="nf">new_get_deferred_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sup</span> <span class="o">=</span> <span class="n">old_get_deferred_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_fields_were_deferred&#39;</span><span class="p">):</span>
            <span class="n">sup</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields_were_deferred</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sup</span>
    <span class="n">model</span><span class="o">.</span><span class="n">get_deferred_fields</span> <span class="o">=</span> <span class="n">new_get_deferred_fields</span>


<span class="k">def</span> <span class="nf">patch_refresh_from_db</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Django &gt;= 1.10: patch refreshing deferred fields. Crucial for only/defer to work.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;refresh_from_db&#39;</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">old_refresh_from_db</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">refresh_from_db</span>

    <span class="k">def</span> <span class="nf">new_refresh_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">append_translated</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">old_refresh_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">refresh_from_db</span> <span class="o">=</span> <span class="n">new_refresh_from_db</span>


<span class="k">def</span> <span class="nf">patch_metaclass</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monkey patches original model metaclass to exclude translated fields on deferred subclasses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old_mcs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span>

    <span class="k">class</span> <span class="nc">translation_deferred_mcs</span><span class="p">(</span><span class="n">old_mcs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This metaclass is essential for deferred subclasses (obtained via only/defer) to work.</span>

<span class="sd">        When deferred subclass is created, some translated fields descriptors could be overridden</span>
<span class="sd">        by DeferredAttribute - which would cause translation retrieval to fail.</span>
<span class="sd">        Prevent this from happening with deleting those attributes from class being created.</span>
<span class="sd">        This metaclass would be called from django.db.models.query_utils.deferred_class_factory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_deferred&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">get_options_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                <span class="n">were_deferred</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="c1"># Field was deferred. Store this for future reference.</span>
                        <span class="n">were_deferred</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">were_deferred</span><span class="p">):</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;_fields_were_deferred&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">were_deferred</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">translation_deferred_mcs</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
    <span class="c1"># Assign to __metaclass__ wouldn&#39;t work, since metaclass search algorithm check for __class__.</span>
    <span class="c1"># http://docs.python.org/2/reference/datamodel.html#__metaclass__</span>
    <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">translation_deferred_mcs</span>


<span class="k">def</span> <span class="nf">delete_cache_fields</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span>
    <span class="n">cached_attrs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_field_cache&#39;</span><span class="p">,</span> <span class="s1">&#39;_field_name_cache&#39;</span><span class="p">,</span> <span class="s1">&#39;_name_map&#39;</span><span class="p">,</span> <span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="s1">&#39;concrete_fields&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;local_concrete_fields&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">cached_attrs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="s1">&#39;_expire_cache&#39;</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">_expire_cache</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">populate_translation_fields</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When models are created or loaded from fixtures, replicates values</span>
<span class="sd">    provided for translatable fields to some / all empty translation fields,</span>
<span class="sd">    according to the current population mode.</span>

<span class="sd">    Population is performed only on keys (field names) present in kwargs.</span>
<span class="sd">    Nothing is returned, but passed kwargs dictionary is altered.</span>

<span class="sd">    With ``mode`` set to:</span>
<span class="sd">    -- ``all``: fills all translation fields, skipping just those for</span>
<span class="sd">       which a translated value is also provided;</span>
<span class="sd">    -- ``default``: fills only the default translation (unless it is</span>
<span class="sd">       additionally provided);</span>
<span class="sd">    -- ``required``: like ``default``, but only if the original field is</span>
<span class="sd">       non-nullable;</span>

<span class="sd">    At least the ``required`` mode should be used when loading untranslated</span>
<span class="sd">    fixtures to keep the database consistent (note that Django management</span>
<span class="sd">    commands are normally forced to run with hardcoded ``en-us`` language</span>
<span class="sd">    active). The ``default`` mode is useful if you need to ensure fallback</span>
<span class="sd">    values are available, and ``all`` if you need to have all translations</span>
<span class="sd">    defined (for example to make lookups / filtering without resorting to</span>
<span class="sd">    query fallbacks).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">populate</span> <span class="o">=</span> <span class="n">mt_settings</span><span class="o">.</span><span class="n">AUTO_POPULATE</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">populate</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">populate</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># What was meant by ``True`` is now called ``all``.</span>
        <span class="n">populate</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>

    <span class="n">opts</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">get_options_for_model</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">populate</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="c1"># Set the value for every language.</span>
                <span class="k">for</span> <span class="n">translation_field</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">translation_field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">populate</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="n">build_localized_fieldname</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mt_settings</span><span class="o">.</span><span class="n">DEFAULT_LANGUAGE</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">populate</span> <span class="o">==</span> <span class="s1">&#39;required&#39;</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="n">build_localized_fieldname</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mt_settings</span><span class="o">.</span><span class="n">DEFAULT_LANGUAGE</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sender</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Unknown population mode &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="n">populate</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">patch_related_object_descriptor_caching</span><span class="p">(</span><span class="n">ro_descriptor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Patch SingleRelatedObjectDescriptor or ReverseSingleRelatedObjectDescriptor to use</span>
<span class="sd">    language-aware caching.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">NewSingleObjectDescriptor</span><span class="p">(</span><span class="n">LanguageCacheSingleObjectDescriptor</span><span class="p">,</span> <span class="n">ro_descriptor</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="n">ro_descriptor</span><span class="o">.</span><span class="n">accessor</span> <span class="o">=</span> <span class="n">ro_descriptor</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span>
    <span class="n">ro_descriptor</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">NewSingleObjectDescriptor</span>


<span class="k">class</span> <span class="nc">Translator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Translator object encapsulates an instance of a translator. Models are</span>
<span class="sd">    registered with the Translator using the register() method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># All seen models (model class -&gt; ``TranslationOptions`` instance).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_or_iterable</span><span class="p">,</span> <span class="n">opts_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers the given model(s) with the given translation options.</span>

<span class="sd">        The model(s) should be Model classes, not instances.</span>

<span class="sd">        Fields declared for translation on a base class are inherited by</span>
<span class="sd">        subclasses. If the model or one of its subclasses is already</span>
<span class="sd">        registered for translation, this will raise an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_iterable</span><span class="p">,</span> <span class="n">ModelBase</span><span class="p">):</span>
            <span class="n">model_or_iterable</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_or_iterable</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">model_or_iterable</span><span class="p">:</span>
            <span class="c1"># Ensure that a base is not registered after a subclass (_registry</span>
            <span class="c1"># is closed with respect to taking bases, so we can just check if</span>
            <span class="c1"># we&#39;ve seen the model).</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">registered</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">AlreadyRegistered</span><span class="p">(</span>
                        <span class="s1">&#39;Model &quot;</span><span class="si">%s</span><span class="s1">&quot; is already registered for translation&#39;</span> <span class="o">%</span>
                        <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">descendants</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                   <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="ow">and</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">model</span><span class="p">]</span>
                    <span class="k">raise</span> <span class="n">DescendantRegistered</span><span class="p">(</span>
                        <span class="s1">&#39;Model &quot;</span><span class="si">%s</span><span class="s1">&quot; cannot be registered after its subclass&#39;</span>
                        <span class="s1">&#39; &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">descendants</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="c1"># Find inherited fields and create options instance for the model.</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_options_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opts_class</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

            <span class="c1"># If an exception is raised during registration, mark model as not-registered</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_register_single_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">registered</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_register_single_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">opts</span><span class="p">):</span>
        <span class="c1"># Now, when all fields are initialized and inherited, validate configuration.</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="c1"># Mark the object explicitly as registered -- registry caches</span>
        <span class="c1"># options of all models, registered or not.</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">registered</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Add translation fields to the model.</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">proxy</span><span class="p">:</span>
            <span class="n">delete_cache_fields</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_translation_fields</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>

        <span class="c1"># Delete all fields cache for related model (parent and children)</span>
        <span class="n">related</span> <span class="o">=</span> <span class="p">((</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">one_to_many</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">one_to_one</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">f</span><span class="o">.</span><span class="n">auto_created</span>
        <span class="p">)</span> <span class="k">if</span> <span class="n">NEW_RELATED_API</span> <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_all_related_objects</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">related_obj</span> <span class="ow">in</span> <span class="n">related</span><span class="p">:</span>
            <span class="n">delete_cache_fields</span><span class="p">(</span><span class="n">related_obj</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># Set MultilingualManager</span>
        <span class="n">add_manager</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># Patch __init__ to rewrite fields</span>
        <span class="n">patch_constructor</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># Connect signal for model</span>
        <span class="k">if</span> <span class="n">NEW_DEFERRED_API</span><span class="p">:</span>
            <span class="n">post_init</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">delete_mt_init</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># deferred models have their own classes and the `sender` does not match.</span>
            <span class="c1"># Connect signal for all models.</span>
            <span class="n">post_init</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">delete_mt_init</span><span class="p">,</span> <span class="n">dispatch_uid</span><span class="o">=</span><span class="s2">&quot;modeltranslation&quot;</span><span class="p">)</span>

        <span class="c1"># Patch clean_fields to verify form field clearing</span>
        <span class="n">patch_clean_fields</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># Patch __metaclass__ and other methods to allow deferring to work</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NEW_DEFERRED_API</span><span class="p">:</span>
            <span class="n">patch_metaclass</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">patch_get_deferred_fields</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">patch_refresh_from_db</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># Substitute original field with descriptor</span>
        <span class="n">model_fallback_languages</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s1">&#39;fallback_languages&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">model_fallback_values</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s1">&#39;fallback_values&#39;</span><span class="p">,</span> <span class="n">NONE</span><span class="p">)</span>
        <span class="n">model_fallback_undefined</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s1">&#39;fallback_undefined&#39;</span><span class="p">,</span> <span class="n">NONE</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">local_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="n">field_fallback_value</span> <span class="o">=</span> <span class="n">parse_field</span><span class="p">(</span><span class="n">model_fallback_values</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">NONE</span><span class="p">)</span>
            <span class="n">field_fallback_undefined</span> <span class="o">=</span> <span class="n">parse_field</span><span class="p">(</span><span class="n">model_fallback_undefined</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">NONE</span><span class="p">)</span>
            <span class="n">descriptor</span> <span class="o">=</span> <span class="n">TranslationFieldDescriptor</span><span class="p">(</span>
                <span class="n">field</span><span class="p">,</span>
                <span class="n">fallback_languages</span><span class="o">=</span><span class="n">model_fallback_languages</span><span class="p">,</span>
                <span class="n">fallback_value</span><span class="o">=</span><span class="n">field_fallback_value</span><span class="p">,</span>
                <span class="n">fallback_undefined</span><span class="o">=</span><span class="n">field_fallback_undefined</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">descriptor</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">):</span>
                <span class="c1"># We need to use a special descriptor so that</span>
                <span class="c1"># _id fields on translated ForeignKeys work</span>
                <span class="c1"># as expected.</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">TranslatedRelationIdDescriptor</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">model_fallback_languages</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">get_attname</span><span class="p">(),</span> <span class="n">desc</span><span class="p">)</span>

                <span class="c1"># Set related field names on other model</span>
                <span class="k">if</span> <span class="n">NEW_RELATED_API</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">is_hidden</span><span class="p">():</span>
                    <span class="n">other_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_options_for_model</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                    <span class="n">other_opts</span><span class="o">.</span><span class="n">related</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">other_opts</span><span class="o">.</span><span class="n">related_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">related_query_name</span><span class="p">())</span>
                    <span class="c1"># Add manager in case of non-registered model</span>
                    <span class="n">add_manager</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">NEW_RELATED_API</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">is_hidden</span><span class="p">():</span>
                    <span class="n">other_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_options_for_model</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="p">)</span>
                    <span class="n">other_opts</span><span class="o">.</span><span class="n">related</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">other_opts</span><span class="o">.</span><span class="n">related_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">related_query_name</span><span class="p">())</span>
                    <span class="n">add_manager</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="p">)</span>  <span class="c1"># Add manager in case of non-registered model</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">OneToOneField</span><span class="p">):</span>
                <span class="c1"># Fix translated_field caching for SingleRelatedObjectDescriptor</span>
                <span class="n">sro_descriptor</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">NEW_RELATED_API</span>
                    <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()))</span>
                <span class="n">patch_related_object_descriptor_caching</span><span class="p">(</span><span class="n">sro_descriptor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unregister</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_or_iterable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unregisters the given model(s).</span>

<span class="sd">        If a model isn&#39;t registered, this will raise NotRegistered. If one of</span>
<span class="sd">        its subclasses is registered, DescendantRegistered will be raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_iterable</span><span class="p">,</span> <span class="n">ModelBase</span><span class="p">):</span>
            <span class="n">model_or_iterable</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_or_iterable</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">model_or_iterable</span><span class="p">:</span>
            <span class="c1"># Check if the model is actually registered (``get_options_for_model``</span>
            <span class="c1"># throws an exception if it&#39;s not).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_options_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="c1"># Invalidate all submodels options and forget about</span>
            <span class="c1"># the model itself.</span>
            <span class="k">for</span> <span class="n">desc</span><span class="p">,</span> <span class="n">desc_opts</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">model</span> <span class="o">!=</span> <span class="n">desc</span> <span class="ow">and</span> <span class="n">desc_opts</span><span class="o">.</span><span class="n">registered</span><span class="p">:</span>
                    <span class="c1"># Allowing to unregister a base would necessitate</span>
                    <span class="c1"># repatching all submodels.</span>
                    <span class="k">raise</span> <span class="n">DescendantRegistered</span><span class="p">(</span>
                        <span class="s1">&#39;You need to unregister descendant &quot;</span><span class="si">%s</span><span class="s1">&quot; before&#39;</span>
                        <span class="s1">&#39; unregistering its base &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">desc</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">desc</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_registered_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abstract</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of all registered models, or just concrete</span>
<span class="sd">        registered models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">model</span> <span class="k">for</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">registered</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">abstract</span> <span class="ow">or</span> <span class="n">abstract</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_get_options_for_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">opts_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an instance of translation options with translated fields</span>
<span class="sd">        defined for the ``model`` and inherited from superclasses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NEW_DEFERRED_API</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">_deferred</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">proxy_for_model</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">:</span>
            <span class="c1"># Create a new type for backwards compatibility.</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">TranslationOptions&quot;</span> <span class="o">%</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">opts_class</span> <span class="ow">or</span> <span class="n">TranslationOptions</span><span class="p">,),</span> <span class="n">options</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>

            <span class="c1"># Fields for translation may be inherited from abstract</span>
            <span class="c1"># superclasses, so we need to look at all parents.</span>
            <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s1">&#39;_meta&#39;</span><span class="p">):</span>
                    <span class="c1"># Things without _meta aren&#39;t functional models, so they&#39;re</span>
                    <span class="c1"># uninteresting parents.</span>
                    <span class="k">continue</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_options_for_model</span><span class="p">(</span><span class="n">base</span><span class="p">))</span>

            <span class="c1"># Cache options for all models -- we may want to compute options</span>
            <span class="c1"># of registered subclasses of unregistered models.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_options_for_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Thin wrapper around ``_get_options_for_model`` to preserve the</span>
<span class="sd">        semantic of throwing exception for models not directly registered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_options_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">registered</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">related</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotRegistered</span><span class="p">(</span><span class="s1">&#39;The model &quot;</span><span class="si">%s</span><span class="s1">&quot; is not registered for &#39;</span>
                                <span class="s1">&#39;translation&#39;</span> <span class="o">%</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">opts</span>


<span class="c1"># This global object represents the singleton translator object</span>
<span class="n">translator</span> <span class="o">=</span> <span class="n">Translator</span><span class="p">()</span>


<span class="c1"># Re-export the decorator for convenience</span>
<span class="kn">from</span> <span class="nn">modeltranslation.decorators</span> <span class="k">import</span> <span class="n">register</span>  <span class="c1"># NOQA re-export</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Martijn van der Klis &amp; Ty Mees

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>