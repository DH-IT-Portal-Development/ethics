

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>django_auth_ldap.backend &mdash; FEtC-H 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> FEtC-H
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Index</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../maintenance/index.html">Maintenance &amp; administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developing/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Server Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">ethics</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">FEtC-H</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>django_auth_ldap.backend</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for django_auth_ldap.backend</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2009, Peter Sagerson</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># - Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1"># list of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1"># - Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1"># this list of conditions and the following disclaimer in the documentation</span>
<span class="c1"># and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c1"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="c1"># DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span>
<span class="c1"># FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="c1"># DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="c1"># SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<span class="c1"># CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="c1"># OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="c1"># OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">LDAP authentication backend</span>

<span class="sd">Complete documentation can be found in docs/howto/auth-ldap.txt (or the thing it</span>
<span class="sd">compiles to).</span>

<span class="sd">Use of this backend requires the python-ldap module. To support unit tests, we</span>
<span class="sd">import ldap in a single centralized place (config._LDAPConfig) so that the test</span>
<span class="sd">harness can insert a mock object.</span>

<span class="sd">A few notes on naming conventions. If an identifier ends in _dn, it is a string</span>
<span class="sd">representation of a distinguished name. If it ends in _info, it is a 2-tuple</span>
<span class="sd">containing a DN and a dictionary of lists of attributes. ldap.search_s returns a</span>
<span class="sd">list of such structures. An identifier that ends in _attrs is the dictionary of</span>
<span class="sd">attributes from the _info structure.</span>

<span class="sd">A connection is an LDAPObject that has been successfully bound with a DN and</span>
<span class="sd">password. The identifier &#39;user&#39; always refers to a User model object; LDAP user</span>
<span class="sd">information will be user_dn or user_info.</span>

<span class="sd">Additional classes can be found in the config module next to this one.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">ldap</span>

<span class="kn">import</span> <span class="nn">django.conf</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="k">import</span> <span class="n">get_user_model</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="k">import</span> <span class="n">Group</span><span class="p">,</span> <span class="n">Permission</span>
<span class="kn">from</span> <span class="nn">django.core.cache</span> <span class="k">import</span> <span class="n">cache</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">ImproperlyConfigured</span><span class="p">,</span> <span class="n">ObjectDoesNotExist</span>
<span class="kn">import</span> <span class="nn">django.dispatch</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="k">import</span> <span class="n">six</span>
<span class="kn">from</span> <span class="nn">django.utils.encoding</span> <span class="k">import</span> <span class="n">force_text</span>
<span class="kn">from</span> <span class="nn">django.utils.inspect</span> <span class="k">import</span> <span class="n">func_supports_parameter</span>

<span class="kn">from</span> <span class="nn">django_auth_ldap.config</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ConfigurationWarning</span><span class="p">,</span> <span class="n">LDAPGroupQuery</span><span class="p">,</span> <span class="n">LDAPSearch</span><span class="p">,</span> <span class="n">_LDAPConfig</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">_LDAPConfig</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>


<span class="c1"># Exported signals</span>

<span class="c1"># Allows clients to perform custom user population.</span>
<span class="n">populate_user</span> <span class="o">=</span> <span class="n">django</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">Signal</span><span class="p">(</span><span class="n">providing_args</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;ldap_user&quot;</span><span class="p">])</span>

<span class="c1"># Allows clients to inspect and perform special handling of LDAPError</span>
<span class="c1"># exceptions. Exceptions raised by handlers will be propagated out.</span>
<span class="n">ldap_error</span> <span class="o">=</span> <span class="n">django</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">Signal</span><span class="p">(</span><span class="n">providing_args</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;exception&#39;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">LDAPBackend</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The main backend class. This implements the auth backend API, although it</span>
<span class="sd">    actually delegates most of its work to _LDAPUser, which is defined next.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">supports_anonymous_user</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">supports_object_permissions</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">supports_inactive_user</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">_settings</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_ldap</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># The cached ldap module (or mock object)</span>

    <span class="c1"># This is prepended to our internal setting names to produce the names we</span>
    <span class="c1"># expect in Django&#39;s settings file. Subclasses can change this in order to</span>
    <span class="c1"># support multiple collections of settings.</span>
    <span class="n">settings_prefix</span> <span class="o">=</span> <span class="s1">&#39;AUTH_LDAP_&#39;</span>

    <span class="c1"># Default settings to override the built-in defaults.</span>
    <span class="n">default_settings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exclude certain cached properties from pickling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_settings&#39;</span><span class="p">,</span> <span class="s1">&#39;_ldap&#39;</span><span class="p">]}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="n">LDAPSettings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings_prefix</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">default_settings</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span>

    <span class="nd">@settings</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="n">settings</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ldap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ldap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">django</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;AUTH_LDAP_GLOBAL_OPTIONS&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_ldap</span> <span class="o">=</span> <span class="n">_LDAPConfig</span><span class="o">.</span><span class="n">get_ldap</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ldap</span>

    <span class="k">def</span> <span class="nf">get_user_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        By default, this will return the model class configured by</span>
<span class="sd">        AUTH_USER_MODEL. Subclasses may wish to override it and return a proxy</span>
<span class="sd">        model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_user_model</span><span class="p">()</span>

    <span class="c1">#</span>
    <span class="c1"># The Django auth backend API</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">password</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">PERMIT_EMPTY_PASSWORD</span><span class="p">:</span>
            <span class="n">ldap_user</span> <span class="o">=</span> <span class="n">_LDAPUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_ldap_user</span><span class="p">(</span><span class="n">ldap_user</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Rejecting empty password for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
            <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">_LDAPUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>  <span class="c1"># This sets user.ldap_user</span>
        <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span> <span class="nf">has_perm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">perm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_module_perms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">app_label</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">perm</span><span class="p">[:</span><span class="n">perm</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span> <span class="o">==</span> <span class="n">app_label</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_all_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group_permissions</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_group_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;ldap_user&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTHORIZE_ALL_USERS</span><span class="p">:</span>
            <span class="n">_LDAPUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>  <span class="c1"># This sets user.ldap_user</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;ldap_user&#39;</span><span class="p">):</span>
            <span class="n">permissions</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">ldap_user</span><span class="o">.</span><span class="n">get_group_permissions</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">permissions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">permissions</span>

    <span class="c1">#</span>
    <span class="c1"># Bonus API: populate the Django user from LDAP without authenticating.</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">populate_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="n">ldap_user</span> <span class="o">=</span> <span class="n">_LDAPUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">ldap_user</span><span class="o">.</span><span class="n">populate_user</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">user</span>

    <span class="c1">#</span>
    <span class="c1"># Hooks for subclasses</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">authenticate_ldap_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ldap_user</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an authenticated Django user or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ldap_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_or_build_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">ldap_user</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This must return a (User, built) 2-tuple for the given LDAP user.</span>

<span class="sd">        username is the Django-friendly username of the user. ldap_user.dn is</span>
<span class="sd">        the user&#39;s DN and ldap_user.attrs contains all of their LDAP</span>
<span class="sd">        attributes.</span>

<span class="sd">        The returned User object may be an unsaved model instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_model</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">USER_QUERY_FIELD</span><span class="p">:</span>
            <span class="n">query_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">USER_QUERY_FIELD</span>
            <span class="n">query_value</span> <span class="o">=</span> <span class="n">ldap_user</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">USER_ATTR_MAP</span><span class="p">[</span><span class="n">query_field</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lookup</span> <span class="o">=</span> <span class="n">query_field</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query_field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">USERNAME_FIELD</span>
            <span class="n">query_value</span> <span class="o">=</span> <span class="n">username</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">lookup</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">__iexact&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query_field</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">lookup</span><span class="p">:</span> <span class="n">query_value</span><span class="p">})</span>
        <span class="k">except</span> <span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">query_field</span><span class="p">:</span> <span class="n">query_value</span><span class="p">})</span>
            <span class="n">built</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">built</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">built</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ldap_to_django_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">username</span>

    <span class="k">def</span> <span class="nf">django_to_ldap_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">username</span>


<span class="k">class</span> <span class="nc">_LDAPUser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents an LDAP user and ultimately fields all requests that the</span>
<span class="sd">    backend receives. This class exists for two reasons. First, it&#39;s</span>
<span class="sd">    convenient to have a separate object for each request so that we can use</span>
<span class="sd">    object attributes without running into threading problems. Second, these</span>
<span class="sd">    objects get attached to the User objects, which allows us to cache</span>
<span class="sd">    expensive LDAP information, especially around groups and permissions.</span>

<span class="sd">    self.backend is a reference back to the LDAPBackend instance, which we need</span>
<span class="sd">    to access the ldap module and any hooks that a subclass has overridden.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">AuthenticationFailed</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># Defaults</span>
    <span class="n">_user</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_user_dn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_user_attrs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_groups</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_group_permissions</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_connection_bound</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#</span>
    <span class="c1"># Initialization</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A new LDAPUser must be initialized with either a username or an</span>
<span class="sd">        authenticated User object. If a user is given, the username will be</span>
<span class="sd">        ignored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">request</span>

        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_authenticated_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Internal error: _LDAPUser improperly initialized.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>

        <span class="c1"># This is all just cached immutable data. There&#39;s no point copying it.</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_username</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_user_dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_dn</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_user_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_attrs</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_group_permissions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_permissions</span>

        <span class="c1"># The connection couldn&#39;t be copied even if we wanted to</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_connection_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_bound</span>

        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Most of our properties are cached from the LDAP server. We only want to</span>
<span class="sd">        pickle a few crucial things.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;backend&#39;</span><span class="p">,</span> <span class="s1">&#39;_username&#39;</span><span class="p">,</span> <span class="s1">&#39;_user&#39;</span><span class="p">]}</span>

    <span class="k">def</span> <span class="nf">_set_authenticated_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">django_to_ldap_username</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">get_username</span><span class="p">())</span>

        <span class="n">user</span><span class="o">.</span><span class="n">ldap_user</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">user</span><span class="o">.</span><span class="n">ldap_username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_username</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ldap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">ldap</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">settings</span>

    <span class="c1">#</span>
    <span class="c1"># Entry points</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticates against the LDAP directory and returns the corresponding</span>
<span class="sd">        User object if successful. Returns None on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_authenticate_user_dn</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_requirements</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_user</span><span class="p">()</span>

            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">AuthenticationFailed</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Authentication failed for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ldap</span><span class="o">.</span><span class="n">LDAPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">ldap_error</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                                      <span class="n">context</span><span class="o">=</span><span class="s1">&#39;authenticate&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="p">,</span>
                                      <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Caught LDAPError while authenticating </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> while authenticating </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span> <span class="nf">get_group_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If allowed by the configuration, this returns the set of permissions</span>
<span class="sd">        defined by the user&#39;s LDAP group memberships.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_permissions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group_permissions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">FIND_GROUP_PERMS</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_load_group_permissions</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">ldap</span><span class="o">.</span><span class="n">LDAPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">ldap_error</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                                              <span class="n">context</span><span class="o">=</span><span class="s1">&#39;get_group_permissions&#39;</span><span class="p">,</span>
                                              <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Caught LDAPError loading group permissions: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_permissions</span>

    <span class="k">def</span> <span class="nf">populate_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populates the Django user object using the default bind credentials.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># self.attrs will only be non-None if we were able to load this user</span>
            <span class="c1"># from the LDAP directory, so this filters out nonexistent users.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_user</span><span class="p">(</span><span class="n">force_populate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user</span>
        <span class="k">except</span> <span class="n">ldap</span><span class="o">.</span><span class="n">LDAPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">ldap_error</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                                      <span class="n">context</span><span class="o">=</span><span class="s1">&#39;populate_user&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="p">,</span>
                                      <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Caught LDAPError while authenticating </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> while authenticating </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">user</span>

    <span class="c1">#</span>
    <span class="c1"># Public properties (callbacks). These are all lazy for performance reasons.</span>
    <span class="c1">#</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_dn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_user_dn</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_dn</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_user_attrs</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_attrs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">group_dns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_groups</span><span class="p">()</span><span class="o">.</span><span class="n">get_group_dns</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">group_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_groups</span><span class="p">()</span><span class="o">.</span><span class="n">get_group_names</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_bound</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span>

    <span class="c1">#</span>
    <span class="c1"># Authentication</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_authenticate_user_dn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Binds to the LDAP server with the user&#39;s DN and password. Raises</span>
<span class="sd">        AuthenticationFailed on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">AuthenticationFailed</span><span class="p">(</span><span class="s2">&quot;failed to map the username to a DN.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sticky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">BIND_AS_AUTHENTICATING_USER</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_bind_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dn</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="n">sticky</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ldap</span><span class="o">.</span><span class="n">INVALID_CREDENTIALS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">AuthenticationFailed</span><span class="p">(</span><span class="s2">&quot;user DN/password rejected by LDAP server.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_user_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">search</span> <span class="o">=</span> <span class="n">LDAPSearch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dn</span><span class="p">,</span> <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_BASE</span><span class="p">,</span> <span class="n">attrlist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">USER_ATTRLIST</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_user_attrs</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_load_user_dn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populates self._user_dn with the distinguished name of our user.</span>

<span class="sd">        This will either construct the DN from a template in</span>
<span class="sd">        AUTH_LDAP_USER_DN_TEMPLATE or connect to the server and search for it.</span>
<span class="sd">        If we have to search, we&#39;ll cache the DN.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_using_simple_bind_mode</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_user_dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_simple_user_dn</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">CACHE_TIMEOUT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cache_key</span> <span class="o">=</span> <span class="n">valid_cache_key</span><span class="p">(</span><span class="s1">&#39;django_auth_ldap.user_dn.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_user_dn</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_or_set</span><span class="p">(</span>
                    <span class="n">cache_key</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_search_for_user_dn</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">CACHE_TIMEOUT</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_user_dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_for_user_dn</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_using_simple_bind_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">USER_DN_TEMPLATE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_simple_user_dn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">USER_DN_TEMPLATE</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">ldap</span><span class="o">.</span><span class="n">dn</span><span class="o">.</span><span class="n">escape_dn_chars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">)</span>

        <span class="n">user_dn</span> <span class="o">=</span> <span class="n">template</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">user_dn</span>

    <span class="k">def</span> <span class="nf">_search_for_user_dn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Searches the directory for a user matching AUTH_LDAP_USER_SEARCH.</span>
<span class="sd">        Populates self._user_dn and self._user_attrs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">USER_SEARCH</span>
        <span class="k">if</span> <span class="n">search</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s1">&#39;AUTH_LDAP_USER_SEARCH must be an LDAPSearch instance.&#39;</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="p">(</span><span class="n">user_dn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_attrs</span><span class="p">)</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user_dn</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">user_dn</span>

    <span class="k">def</span> <span class="nf">_check_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks all authentication requirements beyond credentials. Raises</span>
<span class="sd">        AuthenticationFailed on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_required_group</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_denied_group</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_required_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if the group requirement (AUTH_LDAP_REQUIRE_GROUP) is</span>
<span class="sd">        met. Always returns True if AUTH_LDAP_REQUIRE_GROUP is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">required_group_dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">REQUIRE_GROUP</span>

        <span class="k">if</span> <span class="n">required_group_dn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">required_group_dn</span><span class="p">,</span> <span class="n">LDAPGroupQuery</span><span class="p">):</span>
                <span class="n">required_group_dn</span> <span class="o">=</span> <span class="n">LDAPGroupQuery</span><span class="p">(</span><span class="n">required_group_dn</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">required_group_dn</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">AuthenticationFailed</span><span class="p">(</span><span class="s2">&quot;user does not satisfy AUTH_LDAP_REQUIRE_GROUP&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_check_denied_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if the negative group requirement (AUTH_LDAP_DENY_GROUP)</span>
<span class="sd">        is met. Always returns True if AUTH_LDAP_DENY_GROUP is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">denied_group_dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">DENY_GROUP</span>

        <span class="k">if</span> <span class="n">denied_group_dn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_groups</span><span class="p">()</span><span class="o">.</span><span class="n">is_member_of</span><span class="p">(</span><span class="n">denied_group_dn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_member</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">AuthenticationFailed</span><span class="p">(</span><span class="s2">&quot;user does not satisfy AUTH_LDAP_DENY_GROUP&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">#</span>
    <span class="c1"># User management</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_get_or_create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_populate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the User model object from the database or creates it if it</span>
<span class="sd">        doesn&#39;t exist. Also populates the fields, subject to</span>
<span class="sd">        AUTH_LDAP_ALWAYS_UPDATE_USER.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">save_user</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">ldap_to_django_username</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_username</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="p">,</span> <span class="n">built</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_or_build_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="o">.</span><span class="n">ldap_user</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="o">.</span><span class="n">ldap_username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_username</span>

        <span class="n">should_populate</span> <span class="o">=</span> <span class="n">force_populate</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">ALWAYS_UPDATE_USER</span> <span class="ow">or</span> <span class="n">built</span>

        <span class="k">if</span> <span class="n">built</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating Django user </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="o">.</span><span class="n">set_unusable_password</span><span class="p">()</span>
            <span class="n">save_user</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">should_populate</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Populating Django user </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_populate_user</span><span class="p">()</span>
            <span class="n">save_user</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Give the client a chance to finish populating the user just</span>
            <span class="c1"># before saving.</span>
            <span class="n">populate_user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="p">,</span> <span class="n">ldap_user</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_user</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># This has to wait until we&#39;re sure the user has a pk.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRROR_GROUPS</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRROR_GROUPS_EXCEPT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_mirror_settings</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mirror_groups</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_populate_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populates our User object with information from the LDAP directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_user_from_attributes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_user_from_group_memberships</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_populate_user_from_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">USER_ATTR_MAP</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> does not have a value for the attribute </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dn</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_populate_user_from_group_memberships</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">group_dns</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">USER_FLAGS_BY_GROUP</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_group_dns</span><span class="p">(</span><span class="n">group_dns</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">_name</span><span class="p">(</span><span class="s1">&#39;USER_FLAGS_BY_GROUP&#39;</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_normalize_group_dns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_dns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts one or more group DNs to an LDAPGroupQuery.</span>

<span class="sd">        group_dns may be a string, a non-empty list or tuple of strings, or an</span>
<span class="sd">        LDAPGroupQuery. The result will be an LDAPGroupQuery. A list or tuple</span>
<span class="sd">        will be joined with the | operator.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_dns</span><span class="p">,</span> <span class="n">LDAPGroupQuery</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">group_dns</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_dns</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">LDAPGroupQuery</span><span class="p">(</span><span class="n">group_dns</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_dns</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_dns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">LDAPGroupQuery</span><span class="p">,</span> <span class="n">group_dns</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">group_dns</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">_normalize_mirror_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the group mirroring settings and converts them as necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">malformed_mirror_groups_except</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> must be a collection of group names&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">_name</span><span class="p">(</span><span class="s1">&#39;MIRROR_GROUPS_EXCEPT&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">malformed_mirror_groups</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> must be True or a collection of group names&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">_name</span><span class="p">(</span><span class="s1">&#39;MIRROR_GROUPS&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">mge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRROR_GROUPS_EXCEPT</span>
        <span class="n">mg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRROR_GROUPS</span>

        <span class="k">if</span> <span class="n">mge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mge</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mge</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">mge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRROR_GROUPS_EXCEPT</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">mge</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">malformed_mirror_groups_except</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mge</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">malformed_mirror_groups_except</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">mg</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">ConfigurationWarning</span><span class="p">(</span><span class="s2">&quot;Ignoring </span><span class="si">{}</span><span class="s2"> in favor of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">_name</span><span class="p">(</span><span class="s2">&quot;MIRROR_GROUPS&quot;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">_name</span><span class="p">(</span><span class="s2">&quot;MIRROR_GROUPS_EXCEPT&quot;</span><span class="p">)</span>
                <span class="p">)))</span>
                <span class="n">mg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRROR_GROUPS</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">mg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mg</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mg</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">mg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRROR_GROUPS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">mg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">malformed_mirror_groups</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mg</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mg</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">malformed_mirror_groups</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_mirror_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mirrors the user&#39;s LDAP groups in the Django database and updates the</span>
<span class="sd">        user&#39;s membership.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_group_names</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_groups</span><span class="p">()</span><span class="o">.</span><span class="n">get_group_names</span><span class="p">())</span>
        <span class="n">current_group_names</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">iterator</span><span class="p">())</span>

        <span class="c1"># These were normalized to sets above.</span>
        <span class="n">MIRROR_GROUPS_EXCEPT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRROR_GROUPS_EXCEPT</span>
        <span class="n">MIRROR_GROUPS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">MIRROR_GROUPS</span>

        <span class="c1"># If the settings are white- or black-listing groups, we&#39;ll update</span>
        <span class="c1"># target_group_names such that we won&#39;t modify the membership of groups</span>
        <span class="c1"># beyond our purview.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">MIRROR_GROUPS_EXCEPT</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
            <span class="n">target_group_names</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">target_group_names</span> <span class="o">-</span> <span class="n">MIRROR_GROUPS_EXCEPT</span><span class="p">)</span> <span class="o">|</span>
                <span class="p">(</span><span class="n">current_group_names</span> <span class="o">&amp;</span> <span class="n">MIRROR_GROUPS_EXCEPT</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">MIRROR_GROUPS</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
            <span class="n">target_group_names</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">target_group_names</span> <span class="o">&amp;</span> <span class="n">MIRROR_GROUPS</span><span class="p">)</span> <span class="o">|</span>
                <span class="p">(</span><span class="n">current_group_names</span> <span class="o">-</span> <span class="n">MIRROR_GROUPS</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">target_group_names</span> <span class="o">!=</span> <span class="n">current_group_names</span><span class="p">:</span>
            <span class="n">existing_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__in</span><span class="o">=</span><span class="n">target_group_names</span><span class="p">)</span><span class="o">.</span><span class="n">iterator</span><span class="p">())</span>
            <span class="n">existing_group_names</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">existing_groups</span><span class="p">)</span>

            <span class="n">new_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span>
                          <span class="ow">in</span> <span class="n">target_group_names</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_group_names</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">existing_groups</span> <span class="o">+</span> <span class="n">new_groups</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Group information</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_load_group_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populates self._group_permissions based on LDAP group membership and</span>
<span class="sd">        Django group permissions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_groups</span><span class="p">()</span><span class="o">.</span><span class="n">get_group_names</span><span class="p">()</span>

        <span class="n">perms</span> <span class="o">=</span> <span class="n">Permission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">group__name__in</span><span class="o">=</span><span class="n">group_names</span><span class="p">)</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="n">perms</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;content_type__app_label&#39;</span><span class="p">,</span> <span class="s1">&#39;codename&#39;</span><span class="p">)</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="n">perms</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_group_permissions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an _LDAPUserGroups object, which can determine group</span>
<span class="sd">        membership.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span> <span class="o">=</span> <span class="n">_LDAPUserGroups</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span>

    <span class="c1">#</span>
    <span class="c1"># LDAP connection</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Binds to the LDAP server with AUTH_LDAP_BIND_DN and</span>
<span class="sd">        AUTH_LDAP_BIND_PASSWORD.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bind_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">BIND_DN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">BIND_PASSWORD</span><span class="p">,</span>
                      <span class="n">sticky</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_bind_as</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind_dn</span><span class="p">,</span> <span class="n">bind_password</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Binds to the LDAP server with the given credentials. This does not trap</span>
<span class="sd">        exceptions.</span>

<span class="sd">        If sticky is True, then we will consider the connection to be bound for</span>
<span class="sd">        the life of this object. If False, then the caller only wishes to test</span>
<span class="sd">        the credentials, after which the connection will be considered unbound.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_connection</span><span class="p">()</span><span class="o">.</span><span class="n">simple_bind_s</span><span class="p">(</span><span class="n">force_text</span><span class="p">(</span><span class="n">bind_dn</span><span class="p">),</span>
                                             <span class="n">force_text</span><span class="p">(</span><span class="n">bind_password</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_bound</span> <span class="o">=</span> <span class="n">sticky</span>

    <span class="k">def</span> <span class="nf">_get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns our cached LDAPObject, which may or may not be bound.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">SERVER_URI</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">func_supports_parameter</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="s1">&#39;request&#39;</span><span class="p">):</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s1">&#39;Update AUTH_LDAP_SERVER_URI callable </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> to accept &#39;</span>
                        <span class="s1">&#39;a positional `request` argument. Support for callables &#39;</span>
                        <span class="s1">&#39;accepting no arguments will be removed in a future &#39;</span>
                        <span class="s1">&#39;version.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
                        <span class="ne">DeprecationWarning</span>
                    <span class="p">)</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">ldap</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">bytes_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">opt</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">CONNECTION_OPTIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">START_TLS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initiating TLS&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">start_tls_s</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span>


<span class="k">class</span> <span class="nc">_LDAPUserGroups</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the set of groups that a user belongs to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ldap_user</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">ldap_user</span><span class="o">.</span><span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ldap_user</span> <span class="o">=</span> <span class="n">ldap_user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_search</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_infos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_dns</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_names</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_group_settings</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_group_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the settings we need to deal with groups.</span>

<span class="sd">        Raises ImproperlyConfigured if anything&#39;s not right.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">GROUP_TYPE</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s2">&quot;AUTH_LDAP_GROUP_TYPE must be an LDAPGroupType instance.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_group_search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">GROUP_SEARCH</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_search</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s2">&quot;AUTH_LDAP_GROUP_SEARCH must be an LDAPSearch instance.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_group_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the set of Django group names that this user belongs to by</span>
<span class="sd">        virtue of LDAP group memberships.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_cached_attr</span><span class="p">(</span><span class="s2">&quot;_group_names&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group_infos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_infos</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group_names</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_group_type</span><span class="o">.</span><span class="n">group_name_from_info</span><span class="p">(</span><span class="n">group_info</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">group_info</span> <span class="ow">in</span> <span class="n">group_infos</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_attr</span><span class="p">(</span><span class="s2">&quot;_group_names&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_names</span>

    <span class="k">def</span> <span class="nf">is_member_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_dn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns true if our user is a member of the given group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_member</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Normalize the DN</span>
        <span class="n">group_dn</span> <span class="o">=</span> <span class="n">group_dn</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># If we have self._group_dns, we&#39;ll use it. Otherwise, we&#39;ll try to</span>
        <span class="c1"># avoid the cost of loading it.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_dns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_type</span><span class="o">.</span><span class="n">is_member</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ldap_user</span><span class="p">,</span> <span class="n">group_dn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_member</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_member</span> <span class="o">=</span> <span class="p">(</span><span class="n">group_dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group_dns</span><span class="p">())</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is</span><span class="si">{}</span><span class="s2">a member of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ldap_user</span><span class="o">.</span><span class="n">dn</span><span class="p">,</span> <span class="n">is_member</span> <span class="ow">and</span> <span class="s2">&quot; &quot;</span> <span class="ow">or</span> <span class="s2">&quot; not &quot;</span><span class="p">,</span> <span class="n">group_dn</span>
        <span class="p">))</span>

        <span class="k">return</span> <span class="n">is_member</span>

    <span class="k">def</span> <span class="nf">get_group_dns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a (cached) set of the distinguished names in self._group_infos.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_dns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group_infos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_group_infos</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group_dns</span> <span class="o">=</span> <span class="p">{</span><span class="n">group_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">group_info</span> <span class="ow">in</span> <span class="n">group_infos</span><span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_dns</span>

    <span class="k">def</span> <span class="nf">_get_group_infos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a (cached) list of group_info structures for the groups that our</span>
<span class="sd">        user is a member of.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_infos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_group_infos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_type</span><span class="o">.</span><span class="n">user_groups</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ldap_user</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">_group_search</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_infos</span>

    <span class="k">def</span> <span class="nf">_load_cached_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">CACHE_TIMEOUT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_key</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cache_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">CACHE_TIMEOUT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_key</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">CACHE_TIMEOUT</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Memcache keys can&#39;t have spaces in them, so we&#39;ll remove them from the</span>
<span class="sd">        DN for maximum compatibility.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ldap_user</span><span class="o">.</span><span class="n">dn</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">valid_cache_key</span><span class="p">(</span>
            <span class="s1">&#39;auth_ldap.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">dn</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">key</span>


<span class="k">class</span> <span class="nc">LDAPSettings</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a simple class to take the place of the global settings object. An</span>
<span class="sd">    instance will contain all of our settings as attributes, with default values</span>
<span class="sd">    if they are not specified by the configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_prefix</span> <span class="o">=</span> <span class="s1">&#39;AUTH_LDAP_&#39;</span>

    <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ALWAYS_UPDATE_USER&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;AUTHORIZE_ALL_USERS&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;BIND_AS_AUTHENTICATING_USER&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;BIND_DN&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;BIND_PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CONNECTION_OPTIONS&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;DENY_GROUP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;FIND_GROUP_PERMS&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;CACHE_TIMEOUT&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;GROUP_SEARCH&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;GROUP_TYPE&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;MIRROR_GROUPS&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;MIRROR_GROUPS_EXCEPT&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;PERMIT_EMPTY_PASSWORD&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;REQUIRE_GROUP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;SERVER_URI&#39;</span><span class="p">:</span> <span class="s1">&#39;ldap://localhost&#39;</span><span class="p">,</span>
        <span class="s1">&#39;START_TLS&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;USER_QUERY_FIELD&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;USER_ATTRLIST&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;USER_ATTR_MAP&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;USER_DN_TEMPLATE&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;USER_FLAGS_BY_GROUP&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;USER_SEARCH&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;AUTH_LDAP_&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads our settings from django.conf.settings, applying defaults for any</span>
<span class="sd">        that are omitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">=</span> <span class="n">prefix</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">defaults</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">django</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Compatibility with old caching settings.</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">django</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">(</span><span class="s1">&#39;CACHE_GROUPS&#39;</span><span class="p">),</span> <span class="n">defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CACHE_GROUPS&#39;</span><span class="p">)):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;Found deprecated setting AUTH_LDAP_CACHE_GROUP. Use &#39;</span>
                <span class="s1">&#39;AUTH_LDAP_CACHE_TIMEOUT instead.&#39;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CACHE_TIMEOUT</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="n">django</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">(</span><span class="s1">&#39;GROUP_CACHE_TIMEOUT&#39;</span><span class="p">),</span>
                <span class="n">defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GROUP_CACHE_TIMEOUT&#39;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">valid_cache_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sanitizes a cache key for memcached.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)[:</span><span class="mi">250</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">key</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Martijn van der Klis &amp; Ty Mees

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>